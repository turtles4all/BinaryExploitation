#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <assert.h>
#include <string.h>
#include <errno.h>

char * welcome_message;

void print_string(int addr) {
  int fildes[2];
  assert (pipe(fildes) == 0);
  int i;
  printf("%08x: ", addr); fflush(stdout);
  for( i = 0 ; ; i++ ) {
    int ret = write(fildes[1], (const void *)(addr + i), 1);
    if (ret < 0 && errno == EFAULT) {
      printf("Invalid address!\n");
      break;
    }
    char c = ((const char *)addr)[i];
    if (!c) {
      break;
    }
    printf("%02hhx", c); fflush(stdout);
  }
  printf("\n"); fflush(stdout);
  assert(close(fildes[0]) == 0);
  assert(close(fildes[1]) == 0);
}

void load_flag(char * flag) {
  FILE * fp = fopen("flag", "r");
  if (!fp) {
    printf("Could not find the flag file!\n");
    exit(1);
  }
  int bytes = fread(flag, sizeof(char), 256, fp);
  assert(bytes >= 32);
  fclose(fp);
}

int main(int argc, char** argv) {
  int address;
  welcome_message =
    strdup("Welcome to our hex printer!\n"
           "Give me an address and I'll print it for you!\n");
  char * flag = (char *)malloc(256 * sizeof(flag));
  load_flag(flag);
  printf("%s", welcome_message); fflush(stdout);
  while(1) {
    printf("Address to print (hex format, e.g., 0x40404040): "); fflush(stdout);
    address = 0;
    if (!scanf("%x", &address)) {
      printf("That's not a valid number, exiting\n");
      exit(1);
    }
    if (!address) {
      printf("Exiting\n");
      exit(1);
    }
    print_string(address);
  }
}
