#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <fcntl.h>

unsigned int i=0u;
char c;

char *strs[2] = {
    "Sorry, no flag for you :(\n",
    "Your flag is \"%s\"\n",
};

char flag[32+1];

typedef struct vuln_state {
    char buf[744];
    char *outstr;
} vuln_state;

void vuln() {
    i = 0u;
    vuln_state vs;
    vs.outstr = strs[i];
    puts("Would you like a flag?");
    fflush(stdout);
    while (read(0, &c, 1) > 0 && c!='\n' && i < 808u) {
      vs.buf[i++] = c;
    }
    vs.buf[i] = '\x00';

    printf(vs.outstr, flag);
    fflush(stdout);
    return;
}

void read_flag() {
    int status;
    i = 0u;
    int fd = open("./key", O_RDONLY);
    if (fd < 0) {
        printf("Failed to open flag file; contact an administrator\n");
        fflush(stdout);
        exit(1);
    }
    for(i=0;i<32;i++) {
        status = read(fd, &c, 1);
        if (status <= 0) {
            printf("Failed to read flag character; contact an administrator\n");
            fflush(stdout);
            exit(1);
        }
        flag[i] = c;
    }
    flag[i] = '\x00';
}
        
int main(int argc, char **argv) {

    read_flag();
    vuln();
    return 0;

}
